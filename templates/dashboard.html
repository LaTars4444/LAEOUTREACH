{% extends "base.html" %}
{% block content %}
<div class="row g-4">
 <!-- LIVE TERMINAL (RESTORED) -->
 <div class="col-12">
  <div class="card shadow-lg bg-dark text-white">
   <div class="card-header border-secondary d-flex justify-content-between align-items-center">
    <span class="fw-bold"><i class="fas fa-terminal me-2 text-warning"></i> TITAN LOG ENGINE - PRODUCTION</span>
    <span class="badge bg-success">STREAMS ACTIVE</span>
   </div>
   <div class="card-body p-0"><div id="system-terminal" class="terminal">Awaiting initialization logs...</div></div>
  </div>
 </div>

 <!-- STATS & INDUSTRIAL SETTINGS -->
 <div class="col-12"><div class="card shadow-sm"><div class="card-body d-flex justify-content-around text-center py-4">
  <div><h3>{{ stats.total }}</h3><small class="text-muted fw-bold">TOTAL LEADS</small></div>
  <div class="text-success"><h3>{{ stats.hot }}</h3><small class="text-muted fw-bold">HOT DEALS</small></div>
  <div class="text-primary"><h3>{{ stats.emails }}</h3><small class="text-muted fw-bold">OUTREACH MISSION</small></div>
  <div class="align-self-center d-flex gap-3">
   <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">Settings & App Password</button>
   <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addLeadModal">Manual Lead</button>
   <a href="/leads/export" class="btn btn-sm btn-dark">Export CSV</a>
  </div>
 </div></div></div>

 <div class="col-12">
  <ul class="nav nav-tabs mb-4 border-0" id="titanTab" role="tablist">
   <li class="nav-item"><button class="nav-link active text-uppercase" data-bs-toggle="tab" data-bs-target="#leads">üè† My Leads</button></li>
   <li class="nav-item"><button class="nav-link text-uppercase" data-bs-toggle="tab" data-bs-target="#hunter">üïµÔ∏è Scraper Engine</button></li>
   <li class="nav-item"><button class="nav-link text-uppercase" data-bs-toggle="tab" data-bs-target="#email">üìß Universal Outreach</button></li>
   <li class="nav-item"><button class="nav-link text-uppercase" data-bs-toggle="tab" data-bs-target="#history">üìú Sent History</button></li>
   <li class="nav-item"><button class="nav-link text-uppercase" data-bs-toggle="tab" data-bs-target="#chat">üí¨ Titan AI Intelligence</button></li>
  </ul>
  
  <div class="tab-content">
   <!-- LEADS TABLE -->
   <div class="tab-pane fade show active" id="leads"><div class="card shadow-sm border-0"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>Status</th><th>Address</th><th>Owner</th><th>Link</th></tr></thead><tbody>{% for lead in leads %}<tr><td><select class="form-select form-select-sm border-0 bg-light" onchange="updateStatus({{ lead.id }}, this.value)"><option {% if lead.status == 'New' %}selected{% endif %}>New</option><option {% if lead.status == 'Hot' %}selected{% endif %}>Hot</option></select></td><td class="fw-bold">{{ lead.address }}</td><td>{{ lead.name }}</td><td><a href="{{ lead.link }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-external-link-alt"></i></a></td></tr>{% endfor %}</tbody></table></div></div></div></div>
   
   <!-- SCAPER -->
   <div class="tab-pane fade" id="hunter"><div class="card bg-dark text-white p-5 text-center shadow-lg"><h2 class="fw-bold mb-3"><i class="fas fa-search-dollar text-warning"></i> Lead Scraper Engine</h2><p class="text-muted">High-volume extraction from 1,000+ Site cluster using combinatorial logic.</p><div class="row justify-content-center mt-4 g-3"><div class="col-md-3"><select id="huntState" class="form-select form-select-lg shadow-sm" onchange="loadCities()"><option value="">Select State</option></select></div><div class="col-md-3"><select id="huntCity" class="form-select form-select-lg shadow-sm"><option value="">Select City</option></select></div><div class="col-md-3"><button onclick="runHunt()" class="btn btn-warning btn-lg w-100 fw-bold shadow">LAUNCH SCAPER</button></div></div></div></div>
   
   <!-- OUTREACH MACHINE -->
   <div class="tab-pane fade" id="email"><div class="card shadow-sm border-primary"><div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center"><span>üìß Universal Template Configuration</span><small class="badge bg-white text-primary">Use [[ADDRESS]] and [[NAME]] tags</small></div><div class="card-body p-4"><form action="/email/template/save" method="POST" class="mb-4"><textarea name="template" class="form-control mb-3 shadow-sm" rows="4">{{ user.email_template }}</textarea><button class="btn btn-primary px-5 fw-bold">SAVE UNIVERSAL SCRIPT</button></form><hr>{% if not gmail_connected %}<div class="alert alert-danger">‚ö†Ô∏è Connect Gmail App Password in Settings!</div>{% endif %}<div class="mb-3"><label class="form-label fw-bold">Subject Line</label><input id="emailSubject" class="form-control" value="Regarding property at [[ADDRESS]]"></div><button onclick="sendBlast()" class="btn btn-dark w-100 fw-bold shadow" {% if not gmail_connected %}disabled{% endif %}>üöÄ Run Outreach Mission</button></div></div></div>
   
   <!-- SENT HISTORY (VISIBILITY PANE) -->
   <div class="tab-pane fade" id="history"><div class="card shadow-sm border-0"><div class="card-body p-4"><h5 class="fw-bold mb-3"><i class="fas fa-history me-2 text-info"></i> Previous Sent Messages</h5><div class="list-group">{% for item in history %}<div class="list-group-item"><h6 class="mb-1 fw-bold">{{ item.address }}</h6><p class="mb-1 small">{{ item.message }}...</p><small class="text-primary">Sent to: {{ item.recipient_email }} | {{ item.sent_at.strftime('%Y-%m-%d %H:%M') }}</small></div>{% else %}<div class="text-center py-5 text-muted"><p>No history found in database.</p></div>{% endfor %}</div></div></div></div>

   <!-- AI CHAT HUB (WELCOME RESTORED) -->
   <div class="tab-pane fade" id="chat"><div class="card shadow-sm border-0"><div class="card-header bg-info text-white fw-bold">üí¨ TITAN AI INTELLIGENCE HUB</div><div class="card-body overflow-auto bg-light" id="ai-log" style="height:350px;"><div class="alert alert-secondary small shadow-sm"><b>Titan AI:</b> Welcome to the Intelligence Hub. I am synchronized with your industrial leads. I can analyze properties, draft cash-offer contracts, or plan marketing strategies. How can I assist you today?</div></div><div class="card-footer bg-white border-0"><div class="input-group shadow-sm"><input id="ai-prompt" class="form-control border-0" placeholder="Ask Engine anything..."><button onclick="askAI()" class="btn btn-info text-white fw-bold px-4">Ask Hub</button></div></div></div></div>
  </div>
 </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal fade" id="settingsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><form action="/settings/save" method="POST"><div class="modal-header bg-dark text-white"><h5 class="modal-title fw-bold">‚öôÔ∏è Industrial Configuration</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><div class="alert alert-info small">Passwords are stored behind <b>Industrial Base64-Shifted Encryption</b>. Use a 16-character Google App Password.</div><div class="mb-3"><label class="form-label fw-bold">Gmail Outreach Address</label><input name="smtp_email" class="form-control" value="{{ user.smtp_email or '' }}" required></div><div class="mb-3"><label class="form-label fw-bold">App Password (16-Chars)</label><input type="password" name="smtp_password" class="form-control" placeholder="xxxx xxxx xxxx xxxx" required></div></div><div class="modal-footer"><button class="btn btn-primary w-100 fw-bold">SAVE ENCRYPTED KEYS</button></div></form></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const usData = {{ us_data_json|safe }};
window.onload = function() { const s = document.getElementById("huntState"); for (let st in usData) { let o = document.createElement("option"); o.value = st; o.innerText = st; s.appendChild(o); } setInterval(updateTerminal, 2000); };
function loadCities() { const st = document.getElementById("huntState").value; const c = document.getElementById("huntCity"); c.innerHTML = '<option value="">Select City</option>'; if(st) usData[st].forEach(ct => { let o = document.createElement("option"); o.value = ct; o.innerText = ct; c.appendChild(o); }); }
async function updateTerminal() { const t = document.getElementById('system-terminal'); try { const r = await fetch('/logs'); const l = await r.json(); t.innerHTML = l.join('<br>'); t.scrollTop = t.scrollHeight; } catch(e) {} }
async function runHunt() { const city = document.getElementById('huntCity').value; const state = document.getElementById('huntState').value; if(!city || !state) return alert("Select location."); const r = await fetch('/leads/hunt', {method:'POST', body:new URLSearchParams({city, state})}); const d = await r.json(); alert(d.message); }
async function sendBlast() { const f = new FormData(); f.append('subject', document.getElementById('emailSubject').value); f.append('body', ''); const r = await fetch('/email/campaign', {method:'POST', body:f}); const d = await r.json(); alert(d.message); }
async function askAI() { const p = document.getElementById('ai-prompt').value; const log = document.getElementById('ai-log'); log.innerHTML += `<div class='text-end small mb-2 text-primary'><b>You:</b> ${p}</div>`; const r = await fetch('/ai/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message: p})}); const d = await r.json(); log.innerHTML += `<div class='alert alert-secondary small shadow-sm'><b>Titan AI:</b> ${d.response}</div>`; log.scrollTop = log.scrollHeight; document.getElementById('ai-prompt').value = ''; }
async function updateStatus(id, s) { await fetch('/leads/update/'+id, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:s})}); }
</script>
{% endblock %}
